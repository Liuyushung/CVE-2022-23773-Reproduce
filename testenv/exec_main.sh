#!/bin/bash
BLUE='\033[1;34m'
YELLOW='\033[1;33m'
GREEN='\033[1;32m'
RED='\033[1;31m'
NC='\033[0m'

function case1() {
    # Case 1: go1.11.1 with malicious branch
    echo -e "${YELLOW}Clean environment${NC}"
    rm go.mod go.sum main
    echo "1" | ./install_go.sh

    echo -e "${YELLOW}Create environment to demo CVE-2022-23773${NC}"

    echo -e "${GREEN}In this demo, you will see the main.go use a malicious branch whose name is v0.3.0 and it can work.${NC}"

    go mod init testenv
    go get github.com/Liuyushung/CVE-2022-23773-Reproduce@v0.3.0
    go mod tidy
    go build main.go
    echo ""
    ./main 
}

function case2() {
    # Case 2: go1.11.1 with a vaild tag
    echo -e "${YELLOW}Clean environment${NC}"
    rm go.mod go.sum main
    echo "1" | ./install_go.sh

    echo -e "${YELLOW}Create environment to demo CVE-2022-23773${NC}"

    echo -e "${GREEN}In this demo, you will see the main.go use a valid tag whose name is v1.0.4"
    echo -e "This is a normal use case${NC}"

    go mod init testenv
    go get github.com/Liuyushung/CVE-2022-23773-Reproduce@v1.0.4
    go mod tidy
    go build main.go
    echo ""
    ./main 
}

function case3() {
    # Case 3: go1.11.1 with a normal branch
    echo -e "${YELLOW}Clean environment${NC}"
    rm go.mod go.sum main
    echo "1" | ./install_go.sh

    echo -e "${YELLOW}Create environment to demo CVE-2022-23773${NC}"

    echo -e "${GREEN}In this demo, you will see the main.go use a normal branch whose name is normal"
    echo -e "This is also a normal use case${NC}"

    go mod init testenv
    go get github.com/Liuyushung/CVE-2022-23773-Reproduce@normal
    go mod tidy
    go build main.go
    echo ""
    ./main 
}

function case4() {
    # Case 4: go1.19.3 with malicious branch
    echo -e "${YELLOW}Clean environment${NC}"
    rm go.mod go.sum main
    echo "2" | ./install_go.sh

    echo -e "${YELLOW}Create environment to demo CVE-2022-23773${NC}"

    echo -e "${GREEN}In this demo, you will see the main.go use a malicious branch whose name is v0.3.0 and it can't work."
    echo -e "Since the go will check the name if it a tag.${NC}"

    go mod init testenv
    go get github.com/Liuyushung/CVE-2022-23773-Reproduce@v0.3.0
    echo -e "${RED}You will see the go cmd tool reports that (v0.3.0 is not a tag)${NC}"
    echo ""
}

echo -e "\n${GREEN}Execute case 1${NC}"
case1
sleep 3

echo -e "\n${GREEN}Execute case 2${NC}"
case2
sleep 3

echo -e "\n${GREEN}Execute case 3${NC}"
case3
sleep 3

echo -e "\n${GREEN}Execute case 4${NC}"
case4
sleep 3
